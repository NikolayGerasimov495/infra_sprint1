# infra_sprint1

# Описание

Kittygram — социальная сеть для обмена фотографиями любимых питомцев. Это полностью рабочий проект, который состоит из бэкенд-приложения на Django и фронтенд-приложения на React.

# СТЭК

-Python
-Django 
-React
-DRF 
-Djoser
-Gunicorn
-Nginx


# Доменное имя
1. Получите доменное имя, по которому будет доступно приложение. Начните именно с этой задачи, так как для тестирования работы проекта вам понадобится доменное имя, а для того, чтобы оно попало на все DNS-серверы, нужно время. БЕСПЛАТНО: (1 хост)
  ```
  https://www.noip.com/
  ```

# Подключение к виртуальному серверу
1. Открываем терминал и прописываем:
   ```
   ssh -i путь_до_файла_с_SSH_ключом/название_файла_закрытого_SSH-ключа login@ip
   ```
2. Вводим пароль, если успешно, то будет выглядеть так:
   ```
   yc-user@556013e5d8e7:~$  
   ```



# Начинайте работать с зависимостями и секретными ключами

1. Клонируйте репозиторий:
   ```
   git clone <Ваш репозиторий>
   ```

2. Установить виртуальное окружение для проекта:
    ```
    python -m venv venv
    ```

3. Установите зависимости:
   ```
   pip install -r requirements.txt
   ```
4. В директории /backend/kittygram_backend/ создать файл .env
   ```
   touch .env
   ```
   Пропишите в файле SECRET_KEY = '<ваш_ключ>'
4. Выполните миграции и создайте суперюзера из директории, в которой находится файл manage.py:
   ```
   python3 manage.py migrate
   python3 manage.py createsuperuser
   ```


# Настройка бэкенд-приложения
1. Добавьте в список ALLOWED_HOSTS внешний IP-адрес вашего сервера, адрес 127.0.0.1 , localhost и домен:
   ```
   ALLOWED_HOSTS = ['xxx.xxx.xxx.xxx', '127.0.0.1', 'localhost', 'ваш_домен'] 
   ```
1. Отключите режим дебага для бэкенд-приложения. В файле settings.py установите для константы DEBUG значение False, сохраните и закройте файл настроек:
   ```
   DEBUG = False
   ```
1. Подготовьте бэкенд-приложение для сбора статики.
   ```
   STATIC_URL = 'static_backend'
   STATIC_ROOT = BASE_DIR / 'static_backend'
   ```
1. Соберите статику бэкенд-приложения:
   ```
   python3 manage.py collectstatic
   ```
1. В директории с бэкенд-приложением будет создана директория static_backend/ со всей статикой бэкенд-приложения. Скопируйте директорию static_backend/ в директорию /var/www/название_проекта/:
   ```
   sudo cp -r путь_к_директории_с_бэкенд-приложением/static_backend /var/www/название_проекта
   ```
# Настройка фронтенд-приложения
1. Установите зависимости для фронтенд-приложения. Перейдите в директорию с фронтенд-приложением и выполните команду:
   ```
   npm i
   ```
1. Из директории с фронтенд-приложением выполните команду:
   ```
   npm run build
   ```
1. Скопируйте статику фронта в директорию по умолчанию — /var/www/название_проекта/:
   ```
   sudo cp -r путь_к_директории_с_фронтенд-приложением/build/. /var/www/название_проекта/
   ```

# Настройте WSGI-сервер Gunicorn

1. Установите Gunicorn:
   ```
   pip install gunicorn==20.1.0
   ```
3. Создайте файл конфигурации юнита systemd для Gunicorn в директории /etc/systemd/system/. Назовите его по шаблону gunicorn_название_проекта.service.:
   ```
   sudo nano /etc/systemd/system/gunicorn_название_проекта.service
   ```
4. Подставьте в код из листинга свои данные, добавьте этот код без комментариев в файл конфигурации Gunicorn и сохраните изменения:
    ```
    СМОТРИ ПАПКУ <infra>
    ```

5. Команда sudo systemctl с параметрами start, stop или restart запустит, остановит или перезапустит Gunicorn.
Например, команда запуска юнита с именем gunicorn_название_проекта выглядит так:
    ```
    sudo systemctl start gunicorn_название_проекта
    ```
6. Чтобы systemd следил за работой демона Gunicorn, запускал его при старте системы и при необходимости перезапускал, используйте команду:
    ```
    sudo systemctl enable gunicorn_название_проекта
    ```


# Настройте веб-сервер Nginx
1. Установите Nginx на удалённый сервер:
    ```
    sudo apt install nginx -y
    ```
1. Запустите Nginx командой:
    ```
    sudo systemctl start nginx
    ```
1. Обновите настройки Nginx. Для этого откройте файл конфигурации веб-сервера…
    ```
     sudo nano /etc/nginx/sites-enabled/default
     ДАЛЕЕ СМОТРИ ПАПКУ <infra> и файл <default>
    ```
1. Сохраните изменения в файле конфигурации веб-сервера, закройте файл, проверьте его на корректность:
    ```
    sudo nginx -t
    ```
1. Перезагрузите конфигурацию Nginx:
    ```
    sudo systemctl reload nginx
    ```
1. Чтобы фотографии котиков отображались на сайте, создайте директорию ***media*** в директории ***/var/www/kittygram/***. 
Django-приложение будет использовать эту директорию для хранения картинок.
В настройках бэкенда для константы ***MEDIA_ROOT*** укажите путь до созданной директории ***media***.
Назначьте текущего пользователя владельцем директории media, чтобы Django-приложение могло сохранять картинки. Для этого используйте команду chown:
    ```
    sudo chown -R <имя_пользователя> /var/www/kittygram/media/
    ```
1. Опишите в файле конфигурации блок с префиксом /media/, чтобы Nginx знал, из какой директории забирать фото котиков.
    ```
    СМОТРИ ПАПКУ <infra> и файл <default>
    ```

# Настройка файрвола ufw
1. Активируйте разрешение принимать запросы только на порты 80, 443 и 22:
    ```
    sudo ufw allow 'Nginx Full'
    sudo ufw allow OpenSSH
    ```
1. Включите файрвол:
    ```
    sudo ufw enable
    ```
1. Проверьте работу файрвола:
    ```
    sudo ufw status
    ```

# Настройте шифрование запросов по протоколу HTTPS.
1. Установите certbot. Зайдите на сервер и последовательно выполните команды:
    ```
    sudo apt install snapd
    sudo snap install core; sudo snap refresh core
    sudo snap install --classic certbot
    sudo ln -s /snap/bin/certbot /usr/bin/certbot
    ```
1. Запустите certbot и получите SSL-сертификат. Для этого выполните команду:
    ```
    sudo certbot --nginx
    ```
1. Проверьте конфигурацию Nginx, и если всё в порядке, перезагрузите её.






## Бывает, что порты будут заняты. Используй команды:
```
sudo lsof -i :<port_number> - проверяет занятость портов
sudo kill -9 <process_id> - заверщает процесс 
```
## После изменений в файлах используй полезные команды:
```
sudo systemctl restart gunicorn 
which gunicorn - точный путь до gunicorn
sudo systemctl status gunicorn -проверить работоспособность gunicorn
sudo systemctl daemon-reload - перезапустить изменения
Команда sudo systemctl с параметрами start, stop или restart запустит, остановит или перезапустит Gunicorn.
sudo systemctl reload nginx
```

#Автор Николай Герасимов # infra_sprint1
